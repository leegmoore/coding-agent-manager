# Phase 5.5: Visualization Fix - Stacked Area Chart

## Problem

The current `renderVisualization()` in `public/js/pages/session-detail.js` renders a bar chart with 4 separate vertical bars. This does not match the intended design.

## Required Visualization

A **stacked area chart** showing cumulative context growth over turns.

### Characteristics

| Aspect | Specification |
|--------|---------------|
| Chart type | Stacked area chart |
| X-axis | Turns (0 to currentTurn) |
| Y-axis | Cumulative tokens |
| Layers | User (bottom) → Assistant → Thinking → Tool (top) |
| Stacking | Layers stack vertically on top of each other |
| Time dimension | Shows how context grows as conversation progresses |
| Interaction | Turn slider controls the "end point" of the chart |

### Visual Reference

Similar to OpenAI Agents SDK "Context Lifecycle" visualization:
- Colored layers stacking upward as turns progress
- Each layer shows contribution of that message type
- Total height at any x-position = cumulative tokens at that turn
- **SMOOTH CURVES** - each layer grows at its own rate with natural slopes
- NOT blocky/step-wise - should look like flowing water or terrain

### Critical: Smooth Interpolation

The chart MUST use smooth curve interpolation, NOT blocky steps:

```javascript
// USE THIS - smooth monotonic curves
const area = d3.area()
  .curve(d3.curveMonotoneX)  // <-- REQUIRED for smooth curves
  .x(d => xScale(d.data.turn))
  .y0(d => yScale(d[0]))
  .y1(d => yScale(d[1]));
```

Each layer should have its own natural slope that changes turn-to-turn based on how much that type grew. Tool-heavy turns will show the orange layer growing faster. Thinking-heavy turns will show purple expanding. The result should look organic, not like a staircase.

## Data Structure

`sessionData.turns` array where each turn has:

```javascript
{
  turnIndex: 0,
  cumulative: {
    user: 131,
    assistant: 164,
    thinking: 0,
    tool: 0,
    total: 295
  }
}
```

**Important:** `cumulative` values are already running totals up to that turn. No additional accumulation needed.

## Implementation

### D3 Approach

Use `d3.stack()` and `d3.area()`:

```javascript
// Prepare data for stacking (turns 0 to currentTurn)
const data = sessionData.turns.slice(0, currentTurn + 1).map(t => ({
  turn: t.turnIndex,
  user: t.cumulative.user,
  assistant: t.cumulative.assistant,
  thinking: t.cumulative.thinking,
  tool: t.cumulative.tool
}));

// Create stack generator
const stack = d3.stack()
  .keys(['user', 'assistant', 'thinking', 'tool']);

const series = stack(data);

// Create scales
const xScale = d3.scaleLinear()
  .domain([0, currentTurn])
  .range([0, width]);

const yScale = d3.scaleLinear()
  .domain([0, maxTokens])
  .range([height, 0]);

// Create area generator
const area = d3.area()
  .x(d => xScale(d.data.turn))
  .y0(d => yScale(d[0]))
  .y1(d => yScale(d[1]));

// Render each layer
series.forEach((layer, i) => {
  svg.append('path')
    .datum(layer)
    .attr('d', area)
    .attr('fill', colors[i]);
});
```

### Colors

Use existing COLORS constant:
```javascript
const COLORS = {
  user: '#4A90D9',      // Blue
  assistant: '#5CB85C', // Green
  thinking: '#9B59B6',  // Purple
  tool: '#E67E22'       // Orange
};
```

### Scale Behavior

- Y-axis max = `currentScale * 1000` (from scale input)
- If auto-expand is triggered, scale adjusts and chart re-renders
- X-axis always 0 to currentTurn

### Edge Cases

| Case | Behavior |
|------|----------|
| Turn 0 | Single point or minimal area |
| All zeros for a type | Layer has zero height (invisible) |
| Scale smaller than data | Warning shown, scale auto-expands |

## Files to Modify

| File | Change |
|------|--------|
| `public/js/pages/session-detail.js` | Rewrite `renderVisualization()` |

## Files NOT to Modify

- `public/js/lib/session-detail.js` - lib functions unchanged
- Tests - existing tests should still pass
- Template - no changes needed

## Acceptance Criteria

- [ ] Chart renders as stacked area (not bar chart)
- [ ] **Smooth curves** - uses `d3.curveMonotoneX`, NOT blocky/step-wise
- [ ] X-axis shows turns 0 to currentTurn
- [ ] Y-axis shows tokens up to scale
- [ ] 4 layers stack: User (bottom) → Assistant → Thinking → Tool (top)
- [ ] Layers have correct colors matching legend
- [ ] Moving turn slider updates chart to show data up to that turn
- [ ] Scale input changes Y-axis max
- [ ] Total tokens label still displays below chart
- [ ] No console errors
- [ ] `npm test` passes (existing tests)

## Verification Steps

1. `npm test` - all tests pass
2. Start server: `npm run dev`
3. Open: http://localhost:3000/session-detail
4. Load session: `84e0d3f1-f2ee-4560-87da-05ae7f33a6f0`
5. Verify stacked area chart appears (not bar chart)
6. Move turn slider left - chart shrinks to show fewer turns
7. Move turn slider right - chart expands to show more turns
8. Verify layers stack on top of each other
9. Verify colors match legend
10. Change scale input - Y-axis adjusts

## Notes

- The `calculateBandHeight()` function in lib may no longer be needed for this visualization, but keep it for backward compatibility
- Focus on getting the stacked area chart working correctly
- Smooth curves (using d3.curveMonotoneX) are optional but nice to have
